<div class="min-h-screen bg-gray-50 py-8">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="mb-8">
      <%= link_to "‚Üê Volver al evento", event_path(@event), class: "text-blue-600 hover:text-blue-800 font-medium" %>
    </div>

    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Organizar Grupos Familiares</h1>
      <p class="text-gray-600 mt-2">Evento: <%= @event.title %></p>
    </div>

    <!-- Crear nuevo grupo familiar -->
    <div class="bg-white rounded-lg shadow mb-8 p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Crear Nuevo Grupo Familiar</h2>
      <%= form_with model: [@event, @new_family_group], local: true, class: "flex gap-4 items-end" do |form| %>
        <div class="flex-1">
          <%= form.label :name, "Nombre del grupo", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= form.text_field :name, placeholder: "Familia Garc√≠a, Amigos del colegio, etc.", class: "w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
        </div>
        <div>
          <%= form.submit "Crear Grupo", class: "bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" %>
        </div>
      <% end %>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Grupos Familiares Existentes -->
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Grupos Familiares (<%= @family_groups.count %>)</h2>
        </div>
        <div class="p-6">
          <% if @family_groups.any? %>
            <div class="space-y-4">
              <% @family_groups.each do |group| %>
                <div class="border border-gray-200 rounded-lg p-4">
                  <div class="flex justify-between items-start mb-3">
                    <h3 class="font-medium text-gray-900"><%= group.name %></h3>
                    <div class="flex gap-2">
                      <% if group.hash_id.present? %>
                        <button 
                          onclick="copyGroupLink('<%= rsvp_family_confirm_url(group.hash_id) %>', '<%= group.name %>')"
                          class="text-blue-600 hover:text-blue-800 text-sm bg-transparent border-none cursor-pointer flex items-center gap-1"
                          title="Copiar link de confirmaci√≥n grupal">
                          <i class="text-sm">üîó</i>
                          <span class="text-xs">Copiar Link</span>
                        </button>
                      <% end %>
                      <%= button_to "Eliminar", event_family_group_path(@event, group), 
                          method: :delete,
                          data: { confirm: "¬øEst√°s seguro de que quieres eliminar este grupo? Los invitados ser√°n movidos a 'Sin grupo'." },
                          class: "text-red-600 hover:text-red-800 text-sm bg-transparent border-none cursor-pointer",
                          form: { style: "display: inline;" } %>
                    </div>
                  </div>
                  <div class="space-y-2">
                    <% if group.invitations.any? %>
                      <% group.invitations.each do |invitation| %>
                        <div class="flex justify-between items-center bg-gray-50 rounded p-2">
                          <span class="text-sm text-gray-700"><%= invitation.name %></span>
                          <%= form_with model: invitation, url: invitation_path(invitation), method: :patch, local: true, class: "inline" do |form| %>
                            <%= form.hidden_field :family_group_id, value: nil %>
                            <%= form.submit "Remover", class: "text-xs text-gray-500 hover:text-gray-700 bg-transparent border-none cursor-pointer" %>
                          <% end %>
                        </div>
                      <% end %>
                    <% else %>
                      <p class="text-sm text-gray-500 italic">No hay invitados en este grupo</p>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-gray-500 text-center py-8">No hay grupos familiares creados</p>
          <% end %>
        </div>
      </div>

      <!-- Invitados sin grupo -->
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Invitados Sin Grupo (<%= @invitations_without_group.count %>)</h2>
        </div>
        <div class="p-6">
          <% if @invitations_without_group.any? %>
            <div class="space-y-2">
              <% @invitations_without_group.each do |invitation| %>
                <div class="border border-gray-200 rounded-lg p-3">
                  <div class="flex justify-between items-center">
                    <span class="font-medium text-gray-900"><%= invitation.name %></span>
                    <% if @family_groups.any? %>
                      <%= form_with model: invitation, url: invitation_path(invitation), method: :patch, local: true, class: "inline" do |form| %>
                        <%= form.select :family_group_id, 
                            options_from_collection_for_select(@family_groups, :id, :name),
                            { prompt: "Asignar a grupo..." },
                            { 
                              class: "text-xs border-gray-300 rounded",
                              onchange: "this.form.submit();"
                            } %>
                      <% end %>
                    <% else %>
                      <span class="text-xs text-gray-500">Crea un grupo primero</span>
                    <% end %>
                  </div>
                  <div class="mt-1 text-sm text-gray-600">
                    <span class="<%= invitation.accepted? ? 'text-green-600' : 'text-yellow-600' %>">
                      <%= invitation.accepted? ? "‚úì Confirmado" : "‚è≥ Pendiente" %>
                    </span>
                    ‚Ä¢ <%= invitation.email %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-gray-500 text-center py-8">Todos los invitados est√°n asignados a grupos</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function copyGroupLink(url, groupName) {
  navigator.clipboard.writeText(url).then(function() {
    showNotification(`Link del grupo "${groupName}" copiado al portapapeles üêù`, 'success');
  }).catch(function(err) {
    // Fallback para navegadores que no soportan clipboard API
    fallbackCopyToClipboard(url);
    showNotification(`Link del grupo "${groupName}" copiado üêù`, 'success');
  });
}

function fallbackCopyToClipboard(text) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  document.body.appendChild(textArea);
  textArea.select();
  document.execCommand('copy');
  document.body.removeChild(textArea);
}

function showNotification(message, type = 'success') {
  const notification = document.createElement('div');
  
  if (type === 'success') {
    notification.style.cssText = `
      position: fixed;
      top: 1rem;
      right: 1rem;
      background-color: #10b981;
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      max-width: 20rem;
      font-size: 0.875rem;
      border: 2px solid #059669;
    `;
  } else {
    notification.style.cssText = `
      position: fixed;
      top: 1rem;
      right: 1rem;
      background-color: #ef4444;
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      max-width: 20rem;
      font-size: 0.875rem;
      border: 2px solid #dc2626;
    `;
  }
  
  const icon = type === 'success' ? '‚úÖ' : '‚ùå';
  notification.innerHTML = `
    <span style="font-size: 1.125rem;">${icon}</span>
    <span>${message}</span>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 4000);
}
</script>
