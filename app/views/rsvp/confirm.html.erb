<%
  theme = @event.current_theme
  header_emojis = theme.header_emojis
  title_vars = { title: @event.title, name: @invitation.name, emoji: theme.header_emoji }
  subtitle_vars = { name: @invitation.name, emoji: header_emojis.first }
%>

<% content_for :title, "#{@event.title} - Invitaci√≥n para #{@invitation.name}" %>
<% content_for :description, "#{@invitation.name}, est√°s invitado(a) a #{@event.title}. #{@event.description.present? ? @event.description : 'Te esperamos en este evento especial.'}" %>
<% content_for :og_title, "#{header_emojis.first} #{@event.title} - Invitaci√≥n Especial" %>
<% content_for :og_description, "#{@invitation.name}, tienes una invitaci√≥n especial para #{@event.title}. #{@event.start_time ? "#{theme.date_icon} #{format_date_spanish(@event.start_time)}" : ""} #{@event.location.present? ? "#{theme.location_icon} #{@event.location}" : ""}" %>
<% content_for :og_image_alt, "Invitaci√≥n para #{@event.title} - #{@invitation.name}" %>
<% content_for :og_url, rsvp_confirm_url(hash_id: @invitation.hash_id) %>

<%
  # Mostrar countdown si hay deadline y no ha pasado y la invitaci√≥n no est√° aceptada
  show_countdown = @event.rsvp_deadline && 
                   !rsvp_deadline_passed?(@event) && 
                   @invitation.status != 'accepted'
%>

<%= stylesheet_link_tag 'individual_rsvp', 'data-turbo-track': 'reload' %>

<div class="py-6 w-full" 
     style="background: <%= theme.safe_background_gradient %>; <%= theme.generate_css_variables.map { |k, v| "#{k}: #{v};" }.join(' ') %>"
     data-controller="rsvp" 
     data-rsvp-hash-id-value="<%= @invitation.hash_id %>" 
     <% if show_countdown %>data-rsvp-deadline-value="<%= @event.rsvp_deadline.to_i * 1000 %>"<% end %>>
  
  <!-- Floating elements from theme -->
  <% theme.floating_elements_array.each do |element| %>
    <div class="floating-element" style="<%= element['top'] ? "top: #{element['top']};" : '' %><%= element['left'] ? "left: #{element['left']};" : '' %><%= element['right'] ? "right: #{element['right']};" : '' %><%= element['size'] ? "font-size: #{element['size']};" : '' %>"><%= element['emoji'] %></div>
  <% end %>
  
  <div class="w-full max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
    <!-- Countdown Section -->
    <% if show_countdown %>
      <div class="text-center mb-3 animate-fade-in">
        <div class="inline-block px-3 py-2 rounded-lg shadow-sm" style="background: linear-gradient(135deg, <%= theme.primary_color %> 0%, <%= theme.secondary_color %> 100%); border: 2px solid <%= theme.primary_color %>; color: <%= theme.text_color %>;">
          <div class="flex items-center justify-center space-x-2">
            <div class="text-center flex flex-row">
              <p class="text-xs font-medium">Confirmaciones hasta:</p>
              <p class="text-xs mx-2 font-bold"><%= l(@event.rsvp_deadline, format: :short) %></p>
              <div id="countdown-timer" 
                   class="text-sm font-bold" 
                   data-rsvp-target="countdownTimer"
                   data-deadline="<%= @event.rsvp_deadline.to_i * 1000 %>">
                <!-- El countdown se actualizar√° con JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Mensaje si el deadline ha pasado -->
    <% if @event.rsvp_deadline && rsvp_deadline_passed?(@event) %>
      <div class="text-center mb-6 sm:mb-8 animate-fade-in">
        <div class="mb-4 p-4 sm:p-6 rounded-xl border-3 sm:border-4" style="background: linear-gradient(135deg, <%= theme.primary_color %> 0%, <%= theme.secondary_color %> 100%); border: 3px solid <%= theme.primary_color %>; color: <%= theme.text_color %>;">
          <div class="text-2xl mb-2">‚è∞</div>
          <h3 class="text-lg sm:text-xl font-bold mb-2">Tiempo l√≠mite de confirmaci√≥n cerrado</h3>
          <p class="text-sm sm:text-base mb-2">
            Las confirmaciones cerraron el <%= l(@event.rsvp_deadline, format: :long) %>
          </p>
          <% unless @invitation.status == 'pending' %>
            <p class="text-sm">
              Tu estado actual: <span class="font-bold">
                <%= @invitation.status == 'accepted' ? "En armon√≠a #{theme.status_accepted_emoji}" : "En pausa #{theme.status_declined_emoji}" %>
              </span>
            </p>
          <% end %>
        </div>
      </div>
    <% end %>
    
    <!-- Header con animaci√≥n -->
    <div class="text-center mb-6 sm:mb-8 animate-fade-in">
      <div class="inline-flex items-center justify-center gap-2 mb-4">
        <% header_emojis.each_with_index do |emoji, index| %>
          <div class="inline-block p-3 sm:p-4 bg-white rounded-full shadow-lg border-3 sm:border-4" style="border-color: <%= index.even? ? theme.primary_color : theme.secondary_color %>;">
            <div class="text-3xl sm:text-4xl"><%= emoji %></div>
          </div>
        <% end %>
      </div>
      <h1 class="text-3xl sm:text-4xl font-bold mb-2 px-2" style="color: <%= theme.background_text_color %>; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);">
        <%= theme.interpolate_template(theme.safe_title_template, title_vars) %>
      </h1>
    </div>

    <!-- Indicador de Estado RSVP -->
    <div class="mb-6 mx-2 sm:mx-0" data-rsvp-target="statusIndicator">
      <% case @invitation.status %>
      <% when 'accepted' %>
        <div class="flex items-center justify-center p-4 rounded-xl border-2 rsvp-status-indicator rsvp-status-accepted">
          <div class="flex items-center gap-2">
            <span class="text-2xl animate-bounce"><%= theme.status_accepted_emoji %></span>
            <div class="text-center">
              <p class="font-bold text-sm sm:text-base" style="color: <%= theme.background_text_color %>;">¬°Ya confirmaste tu asistencia!</p>
              <p class="text-xs sm:text-sm" style="color: <%= theme.background_text_color %>;">Tu presencia est√° confirmada en armon√≠a <%= theme.accept_emoji %></p>
            </div>
            <span class="text-xl">‚úÖ</span>
          </div>
        </div>
      <% when 'declined' %>
        <div class="flex items-center justify-center p-4 rounded-xl border-2 rsvp-status-indicator rsvp-status-declined">
          <div class="flex items-center gap-2">
            <span class="text-2xl"><%= theme.status_declined_emoji %></span>
            <div class="text-center">
              <p class="font-bold text-sm sm:text-base" style="color: <%= theme.background_text_color %>;">Has declinado la invitaci√≥n</p>
              <p class="text-xs sm:text-sm" style="color: <%= theme.background_text_color %>;">Esperamos verte en el futuro üíú</p>
            </div>
            <span class="text-xl">üíî</span>
          </div>
        </div>
      <% else %>
        <div class="flex items-center justify-center p-4 rounded-xl border-2 rsvp-status-indicator rsvp-status-pending">
          <div class="flex items-center gap-2">
            <span class="text-2xl"><%= theme.status_pending_emoji %></span>
            <div class="text-center">
              <p class="font-bold text-sm sm:text-base" style="color: <%= theme.background_text_color %>;">Esperando tu confirmaci√≥n</p>
              <p class="text-xs sm:text-sm" style="color: <%= theme.background_text_color %>;">¬øTe unir√°s? <%= theme.accept_emoji %>üíú</p>
            </div>
            <span class="text-xl">‚è≥</span>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Tarjeta principal de invitaci√≥n -->
    <div class="p-4 sm:p-6 lg:p-8 rounded-xl border-3 sm:border-4" style="background: <%= theme.card_background %>; border-color: <%= theme.primary_color %>;">
      <!-- Header de la tarjeta -->
      <div class="text-center mb-4 sm:mb-6">
        <h2 class="text-2xl sm:text-3xl font-bold mb-2 px-2" style="color: <%= theme.background_text_color %>;"><%= @event.title %></h2>
        <p class="text-base sm:text-lg px-2" style="color: <%= theme.background_text_color %>;">
          <%= theme.interpolate_template(theme.safe_subtitle_template, subtitle_vars) %>
        </p>
      </div>

      <!-- Descripci√≥n del evento -->
      <% if @event.description.present? %>
        <div class="mb-6 sm:mb-8 text-center">
          <p class="text-base sm:text-lg leading-relaxed px-2" style="color: <%= theme.background_text_color %>;"><%= @event.description %></p>
          <div class="text-xl sm:text-2xl mt-2"><%= theme.description_emojis %></div>
        </div>
      <% end %>

      <!-- Detalles del evento -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
        <!-- Fecha y Hora -->
        <%= render DetailCardComponent.new(
              icon: theme.date_icon,
              title: "Fecha y Hora",
              body: capture do %>
                <p><%= format_date_spanish(@event.start_time) if @event.start_time %></p>
                <p>
                  <%= format_time_spanish(@event.start_time) if @event.start_time %>
                  <% if @event.end_time %>
                    - <%= format_time_spanish(@event.end_time) %>
                  <% end %>
                </p>
              <% end,
              theme: theme
            ) %>

        <!-- Ubicaci√≥n -->
        <% if @event.location.present? %>
          <%= render DetailCardComponent.new(
                icon: theme.location_icon,
                title: "Lugar del encuentro",
                body: @event.location,
                url: @event.map_url.present? ? @event.map_url : nil,
                button_title: @event.map_url.present? ? "Ver en mapa" : nil,
                theme: theme
              ) %>
        <% end %>

        <!-- Lista de Regalos -->
        <%= render DetailCardComponent.new(
              icon: theme.gifts_icon,
              title: "Lista de Regalos",
              body: "¬°Registra tu regalo para evitar duplicados!",
              url: public_gifts_path(@event.hash_id),
              button_title: "Ver Lista",
              theme: theme
            ) %>
      </div>

      <!-- Mensaje personalizado -->
      <div class="text-center mb-6 sm:mb-8 p-4 sm:p-6 rounded-xl border-3 sm:border-4" style="background: linear-gradient(135deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.4) 100%); border-color: <%= theme.secondary_color %>;">
        <h3 class="text-lg sm:text-xl font-semibold mb-2 px-2" style="color: <%= theme.background_text_color %>;">
          Tu presencia es tan valiosa como una flor en el jard√≠n de la vida
        </h3>
        <p class="text-sm sm:text-base px-2" style="color: <%= theme.background_text_color %>;">
          <%= theme.safe_success_message %>
        </p>
        <div class="text-xl sm:text-2xl mt-3"><%= theme.description_emojis %></div>
      </div>

      <!-- Botones de confirmaci√≥n -->
      <% if rsvp_deadline_active?(@event) %>
        <div data-rsvp-target="confirmationSection">
          <div class="flex flex-col gap-3 sm:gap-4 max-w-md mx-auto">
            <button 
              data-action="click->rsvp#accept"
              data-rsvp-target="acceptButton"
              class="flex items-center justify-between w-full py-3 px-6 rounded-lg font-medium text-sm sm:text-base transition-all duration-200 shadow-lg hover:shadow-xl"
              style="background: linear-gradient(135deg, <%= theme.primary_color %> 0%, <%= theme.secondary_color %> 100%); color: <%= theme.text_color %>;">
              <span class="text-lg"><%= theme.accept_emoji %></span>
              <span class="flex-1"><%= theme.safe_accept_text %></span>
              <span class="text-lg">‚úåÔ∏è</span>
            </button>
            
            <button 
              data-action="click->rsvp#decline"
              data-rsvp-target="declineButton"
              class="flex items-center justify-between w-full py-3 px-6 rounded-lg font-medium text-sm sm:text-base transition-all duration-200 border-2 shadow-lg hover:shadow-xl"
              style="border-color: <%= theme.primary_color %>; background: rgba(255,255,255,0.9); color: <%= theme.background_text_color %>;">
              <span class="text-lg"><%= theme.decline_emoji %></span>
              <span class="flex-1"><%= theme.safe_decline_text %></span>
              <span class="text-lg">üíî</span>
            </button>
          </div>
        </div>
      <% else %>
        <div class="text-center p-4 sm:p-6 rounded-xl border-3 sm:border-4" style="background: linear-gradient(135deg, #F5F5F5 0%, #E0E0E0 100%); border-color: #CCCCCC;">
          <div class="text-2xl mb-2">üîí</div>
          <h3 class="text-lg sm:text-xl font-semibold mb-2" style="color: #666;">
            Confirmaciones cerradas
          </h3>
          <p class="text-sm sm:text-base" style="color: #888;">
            El tiempo para confirmar tu asistencia ha terminado.
            <% if @invitation.status != 'pending' %>
              <br>Tu estado actual se mantiene como: 
              <span class="font-bold">
                <%= @invitation.status == 'accepted' ? 'Confirmado ‚úÖ' : 'Declinado ‚ùå' %>
              </span>
            <% end %>
          </p>
        </div>
      <% end %>

      <!-- Secci√≥n de respuesta (oculta inicialmente) -->
      <div data-rsvp-target="responseSection" class="hidden">
        <!-- El contenido se llenar√° din√°micamente con los partials -->
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center px-4 pb-4" style="color: <%= theme.background_text_color %>;">
      <p class="text-xs sm:text-sm">
        <%= theme.safe_footer_message %>
      </p>
      <p class="text-xs mt-2">
        Miniplan ‚Ä¢ Creando momentos √∫nicos <%= header_emojis.join(' ') %>
      </p>
    </div>
  </div>
</div>