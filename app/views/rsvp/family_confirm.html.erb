<%
  theme = @event.current_theme
  header_emojis = theme.header_emojis
  title_vars = { title: @event.title, name: @family_group.name, emoji: theme.header_emoji }
%>

<% content_for :title, "#{@event.title} - Confirmación Familiar" %>
<% content_for :description, "Confirma la asistencia de tu grupo familiar a #{@event.title}. #{@event.description.present? ? @event.description : 'Te esperamos en este evento especial.'}" %>
<% content_for :og_title, "#{header_emojis.first} #{@event.title} - Confirmación Grupal" %>
<% content_for :og_description, "Confirma la asistencia de tu grupo familiar: #{@family_group.name}. #{@event.start_time ? "#{theme.date_icon} #{format_date_spanish(@event.start_time)}" : ""} #{@event.location.present? ? "#{theme.location_icon} #{@event.location}" : ""}" %>
<% content_for :og_image_alt, "Confirmación familiar para #{@event.title} - #{@family_group.name}" %>
<% content_for :og_url, rsvp_family_confirm_url(hash_id: @family_group.hash_id) %>

<style>
  .floating-element {
    position: absolute;
    opacity: 0.6;
    animation: float 6s ease-in-out infinite;
    pointer-events: none;
    z-index: 1;
  }
  
  .floating-element:nth-child(even) {
    animation-delay: -3s;
    animation-duration: 8s;
  }
  
  .floating-element:nth-child(3n) {
    animation-delay: -1s;
    animation-duration: 7s;
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(180deg); }
  }
</style>

<%
  # Verificar si hay invitaciones pendientes
  has_pending_invitations = @invitations.any? { |invitation| invitation.status == 'pending' }
  
  # Mostrar countdown si hay deadline y no ha pasado y hay invitaciones pendientes
  show_countdown = @event.rsvp_deadline && 
                   !rsvp_deadline_passed?(@event) && 
                   has_pending_invitations
%>

<div class="py-6 w-full" 
     style="background: <%= theme.safe_background_gradient %>; min-height: 100vh; position: relative; overflow-x: hidden; <%= theme.generate_css_variables.map { |k, v| "#{k}: #{v};" }.join(' ') %>"
     data-controller="family-rsvp" 
     data-family-rsvp-hash-id-value="<%= @family_group.hash_id %>" 
     data-family-rsvp-update-url-value="<%= rsvp_family_update_path(@family_group.hash_id) %>"
     <% if show_countdown %>data-family-rsvp-deadline-value="<%= @event.rsvp_deadline.to_i * 1000 %>"<% end %>>
  
  <!-- Floating elements from theme -->
  <% theme.floating_elements_array.each do |element| %>
    <div class="floating-element" style="<%= element['top'] ? "top: #{element['top']};" : '' %><%= element['left'] ? "left: #{element['left']};" : '' %><%= element['right'] ? "right: #{element['right']};" : '' %><%= element['size'] ? "font-size: #{element['size']};" : '' %>"><%= element['emoji'] %></div>
  <% end %>
  
  <div class="w-full max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
    <!-- Countdown Section -->
    <% if show_countdown %>
      <div class="text-center mb-3 animate-fade-in">
        <div class="inline-block px-3 py-2 rounded-lg shadow-sm" style="background: linear-gradient(135deg, <%= theme.primary_color %> 0%, <%= theme.secondary_color %> 100%); border: 2px solid <%= theme.primary_color %>; color: <%= theme.text_color %>;">
          <div class="flex items-center justify-center space-x-2">
            <div class="text-center flex flex-row">
              <p class="text-xs font-medium">Confirmaciones hasta:</p>
              <p class="text-xs mx-2 font-bold"><%= l(@event.rsvp_deadline, format: :short) %></p>
              <div id="countdown-timer" 
                   class="text-sm font-bold" 
                   data-family-rsvp-target="countdownTimer"
                   data-deadline="<%= @event.rsvp_deadline.to_i * 1000 %>">
                <!-- El countdown se actualizará con JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Mensaje si el deadline ha pasado -->
    <% if @event.rsvp_deadline && rsvp_deadline_passed?(@event) %>
      <div class="text-center mb-6 sm:mb-8 animate-fade-in">
        <div class="mb-4 p-4 sm:p-6 rounded-xl border-3 sm:border-4" style="background: linear-gradient(135deg, <%= theme.primary_color %> 0%, <%= theme.secondary_color %> 100%); border: 3px solid <%= theme.primary_color %>; color: <%= theme.text_color %>;">
          <div class="text-2xl mb-2">⏰</div>
          <h3 class="text-lg sm:text-xl font-bold mb-2">Tiempo límite de confirmación cerrado</h3>
          <p class="text-sm sm:text-base mb-2">
            Las confirmaciones cerraron el <%= l(@event.rsvp_deadline, format: :long) %>
          </p>
        </div>
      </div>
    <% end %>

    <!-- Header con animación -->
    <div class="text-center mb-6 sm:mb-8 animate-fade-in">
      <div class="inline-flex items-center justify-center gap-2 mb-4">
        <% header_emojis.each_with_index do |emoji, index| %>
          <div class="inline-block p-3 sm:p-4 bg-white rounded-full shadow-lg border-3 sm:border-4" style="border-color: <%= index.even? ? theme.primary_color : theme.secondary_color %>;">
            <div class="text-3xl sm:text-4xl"><%= emoji %></div>
          </div>
        <% end %>
        <div class="inline-block p-3 sm:p-4 bg-white rounded-full shadow-lg border-3 sm:border-4" style="border-color: <%= theme.secondary_color %>;">
          <div class="text-3xl sm:text-4xl">👨‍👩‍👧‍👦</div>
        </div>
      </div>
      <h1 class="text-3xl sm:text-4xl font-bold mb-2 px-2" style="color: <%= theme.background_text_color %>; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);">
        <%= theme.interpolate_template(theme.safe_title_template, title_vars) %>
      </h1>
      <p class="text-lg sm:text-xl px-2" style="color: <%= theme.background_text_color %>;">
        Grupo: <span class="font-semibold"><%= @family_group.name %></span> 👨‍👩‍👧‍👦
      </p>
    </div>

    <!-- Tarjeta principal de invitación -->
    <div class="p-4 sm:p-6 lg:p-8 rounded-xl border-3 sm:border-4" style="background: <%= theme.card_background %>; border-color: <%= theme.primary_color %>;">
      <!-- Header de la tarjeta -->
      <div class="text-center mb-4 sm:mb-6">
        <h2 class="text-2xl sm:text-3xl font-bold mb-2 px-2" style="color: <%= theme.background_text_color %>;"><%= @event.title %></h2>
        <p class="text-base sm:text-lg px-2" style="color: <%= theme.background_text_color %>;">
          Confirma la asistencia de todos los miembros de tu tribu <%= theme.accept_emoji %>
        </p>
      </div>

      <!-- Descripción del evento -->
      <% if @event.description.present? %>
        <div class="mb-6 sm:mb-8 text-center">
          <p class="text-base sm:text-lg leading-relaxed px-2" style="color: <%= theme.background_text_color %>;"><%= @event.description %></p>
          <div class="text-xl sm:text-2xl mt-2"><%= theme.description_emojis %></div>
        </div>
      <% end %>

      <!-- Detalles del evento -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
        <!-- Fecha y Hora -->
        <%= render DetailCardComponent.new(
              icon: theme.date_icon,
              title: "Fecha y Hora",
              body: capture do %>
                <p><%= format_date_spanish(@event.start_time) if @event.start_time %></p>
                <p>
                  <%= format_time_spanish(@event.start_time) if @event.start_time %>
                  <% if @event.end_time %>
                    - <%= format_time_spanish(@event.end_time) %>
                  <% end %>
                </p>
              <% end,
              theme: theme
            ) %>

        <!-- Ubicación -->
        <% if @event.location.present? %>
          <%= render DetailCardComponent.new(
                icon: theme.location_icon,
                title: "Lugar del encuentro",
                body: @event.location,
                url: @event.map_url.present? ? @event.map_url : nil,
                button_title: @event.map_url.present? ? "Ver en mapa" : nil,
                theme: theme
              ) %>
        <% end %>

        <!-- Lista de Regalos -->
        <%= render DetailCardComponent.new(
              icon: theme.gifts_icon,
              title: "Lista de Regalos",
              body: "¡Registra tu regalo para evitar duplicados!",
              url: public_gifts_path(@event.hash_id),
              button_title: "Ver Lista",
              theme: theme
            ) %>
      </div>

      <!-- Sección de Miembros del Grupo Familiar -->
      <div class="mb-6 sm:mb-8 p-4 sm:p-6 rounded-xl border-3 sm:border-4" style="background: linear-gradient(135deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.4) 100%); border-color: <%= theme.secondary_color %>; position: relative; z-index: 20;">
        <div class="text-center mb-6">
          <div class="text-3xl mb-2">👨‍👩‍👧‍👦</div>
          <h3 class="text-lg sm:text-xl font-semibold mb-2" style="color: <%= theme.background_text_color %>;">
            Miembros de la Tribu: <%= @family_group.name %>
          </h3>
          <p class="text-sm sm:text-base" style="color: <%= theme.background_text_color %>;">
            Confirma quién podrá unirse <%= theme.description_emojis %>
          </p>
        </div>
        
        <div class="space-y-4">
          <% @invitations.each_with_index do |invitation, index| %>
            <div class="member-card" data-family-rsvp-target="memberCard" data-member-id="<%= invitation.id %>">
              <div class="flex items-center justify-between gap-4">
                <div class="flex items-center flex-1 min-w-0">
                  <div class="flex-shrink-0 mr-3">
                    <% if invitation.status == 'accepted' %>
                      <span class="text-xl"><%= theme.status_accepted_emoji %></span>
                    <% elsif invitation.status == 'declined' %>
                      <span class="text-xl"><%= theme.status_declined_emoji %></span>
                    <% else %>
                      <span class="text-xl"><%= theme.status_pending_emoji %></span>
                    <% end %>
                  </div>
                  <div class="flex-1 min-w-0">
                    <h4 class="font-semibold text-sm mb-1 truncate" style="color: <%= theme.background_text_color %>;"><%= invitation.name %></h4>
                    <div class="status-badge status-<%= invitation.status %>" style="font-size: 0.75rem; padding: 0.125rem 0.5rem;">
                      <%= invitation.status == 'accepted' ? "#{theme.accept_emoji} En armonía" : (invitation.status == 'declined' ? "#{theme.decline_emoji} En pausa" : "#{theme.status_pending_emoji} Pensándolo") %>
                    </div>
                  </div>
                </div>
                
                <% if rsvp_deadline_active?(@event) %>
                  <div class="flex gap-2 flex-shrink-0">
                    <button 
                      type="button"
                      onclick="updateMemberStatus(<%= invitation.id %>, 'accepted')"
                      class="flex items-center justify-between w-full py-2 px-4 rounded-lg font-medium text-sm transition-all duration-200 shadow-lg hover:shadow-xl"
                      style="background: linear-gradient(135deg, <%= theme.primary_color %> 0%, <%= theme.secondary_color %> 100%); color: <%= theme.text_color %>; min-height: 2.5rem;"
                      data-family-rsvp-target="acceptButton"
                      data-member-id="<%= invitation.id %>">
                      <span class="text-lg"><%= theme.accept_emoji %></span>
                      <span>¡Cuenta conmigo!</span>
                      <span class="text-sm">✌️</span>
                    </button>
                    
                    <button 
                      type="button"
                      onclick="updateMemberStatus(<%= invitation.id %>, 'declined')"
                      class="flex items-center justify-between w-full py-2 px-4 rounded-lg font-medium text-sm transition-all duration-200 shadow-lg hover:shadow-xl border-2"
                      style="border-color: <%= theme.primary_color %>; background: rgba(255,255,255,0.9); color: <%= theme.background_text_color %>; min-height: 2.5rem;"
                      data-family-rsvp-target="declineButton"
                      data-member-id="<%= invitation.id %>">
                      <span class="text-sm"><%= theme.decline_emoji %></span>
                      <span>No podré ir</span>
                      <span class="text-lg">💔</span>
                    </button>
                  </div>
                <% else %>
                  <div class="flex-shrink-0">
                    <div class="text-center py-2 px-3 rounded-lg" style="background-color: #f5f5f5; border: 1px solid #ddd; font-size: 0.75rem;">
                      <p class="text-xs" style="color: #666;">
                        Confirmaciones cerradas - Estado: 
                        <span class="font-bold">
                          <%= invitation.status == 'accepted' ? "En armonía #{theme.accept_emoji}" : (invitation.status == 'declined' ? "En pausa #{theme.decline_emoji}" : "Pensándolo #{theme.status_pending_emoji}") %>
                        </span>
                      </p>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Mensaje personalizado -->
      <div class="text-center mb-6 sm:mb-8 p-4 sm:p-6 rounded-xl border-3 sm:border-4" style="background: linear-gradient(135deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.4) 100%); border-color: <%= theme.secondary_color %>;">
        <h3 class="text-lg sm:text-xl font-semibold mb-2 px-2" style="color: <%= theme.background_text_color %>;">
          Cada alma es especial como una flor en el jardín de la vida
        </h3>
        <p class="text-sm sm:text-base px-2" style="color: <%= theme.background_text_color %>;">
          Esperamos que toda la tribu <%= @family_group.name %> pueda unirse a nuestro evento. 
          Que cada confirmación fluya con la armonía del universo. <%= theme.description_emojis %>
        </p>
        <div class="text-xl sm:text-2xl mt-3"><%= theme.description_emojis %> 👨‍👩‍👧‍👦</div>
      </div>

      <!-- Sección de respuesta (para mostrar mensajes) -->
      <div data-family-rsvp-target="responseSection" class="hidden">
        <!-- El contenido se llenará dinámicamente -->
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center px-4 pb-4" style="color: <%= theme.background_text_color %>;">
      <p class="text-xs sm:text-sm">
        <%= theme.safe_footer_message %>
      </p>
      <p class="text-xs mt-2">
        Miniplan • Creando momentos únicos <%= header_emojis.join(' ') %>
      </p>
    </div>
  </div>
</div>